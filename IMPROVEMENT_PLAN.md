# MIDI 控制器改进计划

## 项目状态
✅ **基础MIDI信号发送** - 已完成（USB MIDI包格式修复）

## 待实现功能清单

### 第一阶段：设备管理优化

#### 1. USB设备实时列表更新
- [x] 添加USB设备插拔监听器（BroadcastReceiver）
- [x] 实现权限确认后自动刷新设备列表
- [x] 优化设备发现和连接流程
- [x] 测试：插入USB后无需重启程序即可选择设备

**技术要点**：
- 监听 `UsbManager.ACTION_USB_DEVICE_ATTACHED/DETACHED`
- 在权限确认后调用设备刷新方法
- 更新Flutter端设备列表显示

#### 2. 显示设备友好名称
- [x] 获取设备的productName和manufacturerName
- [x] 实现友好名称显示逻辑（优先级：productName > manufacturerName > vendorId:productId）
- [x] 保持内部设备ID用于识别
- [x] 测试：显示"nux ngs6"而非"/dev/bus/usb/001/002"

**技术要点**：
- 使用 `UsbDevice.getProductName()` 和 `getManufacturerName()`
- 处理null值情况
- 更新设备列表数据结构

#### 3. 优化权限处理流程
- [x] 改进权限申请的用户体验
- [x] 减少重复权限确认次数
- [x] 添加权限状态检查和提示
- [x] 测试：权限流程更流畅

**技术要点**：
- 优化权限申请时机
- 改进权限回调处理
- 添加用户友好的权限提示

### 第二阶段：用户体验改进

#### 4. 移除系统级USB唤醒
- [x] 修改AndroidManifest.xml移除USB_DEVICE_ATTACHED意图过滤器
- [x] 保持手动设备检测功能
- [x] 测试：插入USB不会自动启动应用

**技术要点**：
- 移除或注释AndroidManifest.xml中的USB意图过滤器
- 确保设备检测功能仍然可用

#### 5. 按钮ON/OFF状态切换
- [x] 为每个按钮添加状态管理（按下/释放）
- [x] 扩展按钮配置支持ON和OFF两种MIDI消息
- [x] 按钮UI反映当前状态（颜色/文字变化）
- [x] 更新配置界面支持双消息设置
- [ ] 测试：按钮切换发送不同MIDI消息

**技术要点**：
- 扩展ButtonConfig数据结构
- 添加按钮状态枚举（ON/OFF/IDLE）
- 修改MIDI发送逻辑
- 更新UI状态显示

#### 6. 设备状态监控
- [ ] 实现设备连接状态实时监控
- [ ] 添加设备断开检测和提示
- [ ] 优化设备重连机制
- [ ] 测试：设备状态变化的UI反馈

**技术要点**：
- 监控设备连接状态
- 实现自动重连机制
- 添加状态指示器

### 第三阶段：完善功能

#### 7. 错误处理和用户反馈
- [ ] 改进错误消息显示
- [ ] 添加操作成功/失败的视觉反馈
- [ ] 优化日志记录
- [ ] 测试：各种异常情况的处理

#### 8. 配置管理优化
- [ ] 实现配置的持久化存储
- [ ] 添加配置导入/导出功能
- [ ] 支持多设备配置切换
- [ ] 测试：配置保存和恢复

## 实现优先级

1. **高优先级**：设备实时更新、友好名称显示
2. **中优先级**：按钮ON/OFF切换、移除自动唤醒
3. **低优先级**：权限优化、状态监控、配置管理

## 测试验证步骤

每个功能实现后需要验证：
1. 功能正常工作
2. 不影响现有功能
3. 用户体验流畅
4. 错误处理正确

## 开发日志

- **2025-08-01**: 创建改进计划文档
- **2025-08-01**: ✅ 完成USB MIDI包格式修复，MIDI信号发送成功
