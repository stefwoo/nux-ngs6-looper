# Looper区域MIDI回传信号监控功能实现计划

## 项目概述

本计划旨在为looper区域添加MIDI回传信号监控功能，实现按钮状态和显示内容根据效果器回传的MIDI信号动态更新。

## 需求分析

### 当前问题
- [ ] 缺少MIDI回传信号接收机制
- [ ] 按钮状态无法动态更新
- [ ] 没有按钮启用/禁用逻辑
- [ ] 状态管理不完整

### 目标功能
- [ ] 监控效果器回传的MIDI信号
- [ ] 根据回传信号动态更新按钮标签
- [ ] 实现按钮闪烁效果
- [ ] 控制按钮启用/禁用状态
- [ ] 更新状态显示栏

## MIDI信号映射

### 发送信号（固定）
| 按钮 | MIDI信号 | 说明 |
|------|----------|------|
| 录音 | B0 2D 01 | 录音开启/叠加录音 |
| 停止 | B0 2D 02 | 停止播放 |
| 清除 | B0 2D 04 | 清除录音 |
| Undo/Redo | B0 2D 08 | 撤销/恢复叠加录音 |

### 回传信号处理
| 回传信号 | 状态变化 | 录音按钮标签 | 闪烁状态 | 其他按钮状态 |
|----------|----------|--------------|----------|--------------|
| B0 2D 00 | 清除完成 | REC | 否 | 停止/清除禁用 |
| B0 2D 01 | 开始录音 | REC | 是 | 停止/清除启用 |
| B0 2D 02 | 录音完成播放 | PLAY | 是 | 停止/清除启用 |
| B0 2D 03 | 开始叠加录音 | DUB REC | 是 | 停止/清除/Undo启用 |
| B0 2D 04 | 停止播放 | PLAY | 否 | 停止禁用，清除启用 |
| B0 2D 09 | 等待录音 | WAIT REC | 否 | 停止/清除禁用 |
| B0 2D 12 | 叠加录音完成播放 | PLAY | 是 | 停止/清除/Undo启用 |
| B0 2D 22 | 撤销叠加录音 | PLAY | 是 | Undo标签→REDO |

## 实施计划

### 阶段1：扩展MidiService
- [x] **任务1.1：** 在MidiService中添加MIDI回传信号监听方法
- [x] **任务1.2：** 实现MIDI消息解析逻辑（解析B0 2D XX格式）
- [x] **任务1.3：** 添加回调机制通知应用层状态变化
- [x] **任务1.4：** 在Android原生代码中实现MIDI接收功能

### 阶段2：创建状态管理
- [x] **任务2.1：** 创建LooperState枚举类定义所有可能状态
- [x] **任务2.2：** 创建LooperStateManager类管理状态转换
- [x] **任务2.3：** 实现状态变化时的按钮配置映射
- [ ] **任务2.4：** 添加状态持久化机制（如需要）

### 阶段3：重构LooperControls组件
- [ ] **任务3.1：** 将LooperControls改为StatefulWidget
- [ ] **任务3.2：** 添加按钮状态属性（文本、启用状态、闪烁状态）
- [ ] **任务3.3：** 实现按钮闪烁动画效果
- [ ] **任务3.4：** 实现按钮启用/禁用视觉反馈
- [ ] **任务3.5：** 保持原有的MIDI发送功能

### 阶段4：增强LooperStatus组件
- [ ] **任务4.1：** 根据looper状态显示中文状态描述
- [ ] **任务4.2：** 添加状态指示器颜色变化
- [ ] **任务4.3：** 可选：添加录音时长显示功能
- [ ] **任务4.4：** 优化状态显示的用户体验

### 阶段5：主应用集成
- [ ] **任务5.1：** 在main.dart中初始化MIDI监听服务
- [ ] **任务5.2：** 在MainContent中集成LooperStateManager
- [ ] **任务5.3：** 实现MIDI回传信号到UI状态的数据流
- [ ] **任务5.4：** 确保状态同步和错误处理

### 阶段6：测试和优化
- [ ] **任务6.1：** 测试所有MIDI信号场景
- [ ] **任务6.2：** 验证按钮状态转换逻辑
- [ ] **任务6.3：** 测试闪烁效果和用户交互
- [ ] **任务6.4：** 性能优化和内存泄漏检查
- [ ] **任务6.5：** 错误场景处理和容错机制

## 文件修改清单

### 新增文件
- [ ] `lib/models/looper_state.dart` - Looper状态枚举和模型
- [ ] `lib/services/looper_state_manager.dart` - Looper状态管理器
- [ ] `lib/utils/midi_message_parser.dart` - MIDI消息解析工具

### 修改文件
- [ ] `lib/services/midi_service.dart` - 添加MIDI接收功能
- [ ] `lib/widgets/looper_controls.dart` - 重构为有状态组件
- [ ] `lib/widgets/looper_status.dart` - 增强状态显示
- [ ] `lib/widgets/main_content.dart` - 集成状态管理
- [ ] `lib/main.dart` - 初始化MIDI监听
- [ ] `android/app/src/main/kotlin/.../MainActivity.kt` - 添加MIDI接收原生代码

### 可能需要修改的文件
- [ ] `lib/constants/app_colors.dart` - 添加新的状态颜色
- [ ] `pubspec.yaml` - 添加可能需要的依赖包

## 风险评估和缓解策略

### 技术风险
- [ ] **风险1：** MIDI接收可能存在延迟
  - **缓解：** 实现异步处理和状态缓存
- [ ] **风险2：** 状态同步可能出现竞态条件
  - **缓解：** 使用状态管理模式确保状态一致性
- [ ] **风险3：** 闪烁效果可能影响性能
  - **缓解：** 优化动画实现，避免不必要的重绘

### 用户体验风险
- [ ] **风险4：** 状态变化可能过于频繁
  - **缓解：** 添加防抖机制和状态变化动画
- [ ] **风险5：** 按钮状态可能不直观
  - **缓解：** 添加详细的状态说明和视觉反馈

## 完成标准

### 功能完成标准
- [ ] 所有MIDI回传信号都能正确解析和处理
- [ ] 按钮状态根据信号正确更新
- [ ] 闪烁效果正常工作
- [ ] 按钮启用/禁用逻辑正确
- [ ] 状态显示栏正确反映当前状态

### 质量标准
- [ ] 代码覆盖率达到80%以上
- [ ] 没有内存泄漏
- [ ] UI响应时间小于100ms
- [ ] 支持所有测试场景

## 时间估算

| 阶段 | 预估时间 | 备注 |
|------|----------|------|
| 阶段1 | 2-3天 | 包含Android原生代码修改 |
| 阶段2 | 1-2天 | 状态管理设计较为关键 |
| 阶段3 | 2-3天 | UI组件重构和动画实现 |
| 阶段4 | 1天 | 相对简单的UI增强 |
| 阶段5 | 1-2天 | 集成和数据流设计 |
| 阶段6 | 2-3天 | 测试和优化 |
| **总计** | **9-14天** | 根据实际情况可能有所调整 |

## 开始执行

准备开始执行此计划时，请从阶段1开始，按顺序完成每个任务。每完成一个任务，请在对应的复选框中打勾。

---

**创建时间：** 2025年8月2日  
**最后更新：** 2025年8月2日  
**状态：** 待执行
